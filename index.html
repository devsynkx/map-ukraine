<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–∞—Ä—Ç–∞ –£–∫—Ä–∞—ó–Ω–∏ ‚Äî —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π</title>
  <style>
    body { margin: 0; font-family: system-ui, Arial; }
    .app { display: grid; grid-template-columns: 320px 1fr; height: 100vh; }
    .panel { padding: 16px; border-right: 1px solid #ddd; display: flex; flex-direction: column; gap: 12px; }
    .mapWrap { padding: 16px; overflow: auto; }

    .row { display: flex; align-items: center; gap: 10px; }
    .btn { padding: 10px 12px; border: 1px solid #ccc; background: #fff; border-radius: 10px; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .hint { font-size: 13px; opacity: .75; line-height: 1.35; }

    /* –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –≤–∏–±—Ä–∞–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ */
    .region { cursor: pointer; transition: opacity .1s ease; }
    .region:hover { opacity: .9; }
    .selected { outline: none; filter: drop-shadow(0 0 2px rgba(0,0,0,.35)); }

    /* —â–æ–± SVG –Ω–µ ‚Äú—Å—Ç–∏—Å–∫–∞–≤—Å—è‚Äù */
    svg { width: max(900px, 100%); height: auto; display: block; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h2 style="margin:0 0 6px;">–§–∞—Ä–±—É–≤–∞–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π</h2>

      <div class="row">
        <input id="color" type="color" value="#ffcc00" />
        <button class="btn" id="apply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∫–æ–ª—ñ—Ä</button>
      </div>

      <div class="row">
        <button class="btn" id="reset">–°–∫–∏–Ω—É—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è</button>
        <button class="btn" id="export">–ï–∫—Å–ø–æ—Ä—Ç PNG</button>
      </div>

      <div id="info" class="hint">
        1) –ö–ª—ñ–∫–Ω–∏ –ø–æ –æ–±–ª–∞—Å—Ç—ñ –Ω–∞ –∫–∞—Ä—Ç—ñ<br/>
        2) –û–±–µ—Ä–∏ –∫–æ–ª—ñ—Ä<br/>
        3) –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∫–æ–ª—ñ—Ä‚Äù
      </div>

      <div class="hint" style="margin-top:auto;">
        –ü–æ—Ä–∞–¥–∞: —è–∫—â–æ —Ç—Ä–µ–±–∞ —Å–ø–∏—Å–æ–∫ –∑ –Ω–∞–∑–≤–∞–º–∏ –æ–±–ª–∞—Å—Ç–µ–π ‚Äî —Å–∫–∞–∂–∏, –¥–∞–º –≤–∞—Ä—ñ–∞–Ω—Ç –ø—ñ–¥ GeoJSON / –Ω–æ—Ä–º–∞–ª—å–Ω—ñ id.
      </div>
    </aside>

    <main class="mapWrap">
      <div id="mapHost">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏‚Ä¶</div>
    </main>
  </div>

  <script>
    const mapHost = document.getElementById('mapHost');
    const colorInput = document.getElementById('color');
    const info = document.getElementById('info');

    let svgEl = null;
    let selectedEl = null;
    let selectedLabel = '';

    // 1) –ü—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ SVG —è–∫ inline (—â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –º—ñ–Ω—è—Ç–∏ fill)
    fetch('map.svg')
      .then(r => r.text())
      .then(svgText => {
        mapHost.innerHTML = svgText;
        svgEl = mapHost.querySelector('svg');

        // 2) –ü–æ–∑–Ω–∞—á–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏-–æ–±–ª–∞—Å—Ç—ñ –∫–ª–∞—Å–æ–º .region
        // –ë–µ—Ä–µ–º–æ path/polygon (–º–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ rect —è–∫—â–æ —Ç—Ä–µ–±–∞)
        const candidates = svgEl.querySelectorAll('path, polygon');

        candidates.forEach((el, idx) => {
          // —Ñ—ñ–ª—å—Ç—Ä: —ñ–≥–Ω–æ—Ä—É—î–º–æ "none" —ñ –¥—É–∂–µ –¥—Ä—ñ–±–Ω—ñ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
          const fill = (el.getAttribute('fill') || '').toLowerCase();
          if (fill === 'none') return;

          el.classList.add('region');

          // –Ø–∫—â–æ –Ω–µ–º–∞ id ‚Äî –¥–∞–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π, —â–æ–± –±—É–ª–æ –∑—Ä—É—á–Ω—ñ—à–µ –¥–µ–±–∞–∂–∏—Ç–∏
          if (!el.id) el.id = `region-${idx+1}`;
        });

        // 3) –ö–ª—ñ–∫ –ø–æ –æ–±–ª–∞—Å—Ç—ñ = –≤–∏–±—ñ—Ä
        svgEl.addEventListener('click', (e) => {
          const target = e.target.closest('.region');
          if (!target) return;

          selectRegion(target);
        });

        info.textContent = '–ö–ª—ñ–∫–Ω–∏ –ø–æ –æ–±–ª–∞—Å—Ç—ñ –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ —ó—ó.';
      })
      .catch(err => {
        mapHost.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ map.svg. –ü–µ—Ä–µ–≤—ñ—Ä, —â–æ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç—å –ø–æ—Ä—É—á –∑ index.html';
        console.error(err);
      });

    function selectRegion(el) {
      if (selectedEl) selectedEl.classList.remove('selected');
      selectedEl = el;
      selectedEl.classList.add('selected');

      // –ü—ñ–¥—Ç—è–≥–Ω–µ–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ–ª—ñ—Ä —É picker (—è–∫—â–æ –≤—ñ–Ω —É hex)
      const fill = selectedEl.getAttribute('fill') || getComputedStyle(selectedEl).fill;
      const hex = rgbToHex(fill);
      if (hex) colorInput.value = hex;

      selectedLabel = selectedEl.id || '(no-id)';
      info.innerHTML = `–í–∏–±—Ä–∞–Ω–æ: <b>${escapeHtml(selectedLabel)}</b>`;
    }

    document.getElementById('apply').addEventListener('click', () => {
      if (!selectedEl) {
        alert('–°–ø–æ—á–∞—Ç–∫—É –∫–ª—ñ–∫–Ω–∏ –ø–æ –æ–±–ª–∞—Å—Ç—ñ –Ω–∞ –∫–∞—Ä—Ç—ñ üôÇ');
        return;
      }
      selectedEl.style.setProperty('fill', colorInput.value, 'important');
        selectedEl.setAttribute('fill', colorInput.value);
    });

    document.getElementById('reset').addEventListener('click', () => {
      if (selectedEl) selectedEl.classList.remove('selected');
      selectedEl = null;
      info.textContent = '–í–∏–¥—ñ–ª–µ–Ω–Ω—è —Å–∫–∏–Ω—É—Ç–æ. –ö–ª—ñ–∫–Ω–∏ –ø–æ –æ–±–ª–∞—Å—Ç—ñ –Ω–∞ –∫–∞—Ä—Ç—ñ.';
    });

    document.getElementById('export').addEventListener('click', () => {
        if (!svgEl) return;

        const serializer = new XMLSerializer();
        const svgText = serializer.serializeToString(svgEl);

        // --- —Å—Ç–≤–æ—Ä—é—î–º–æ image –∑ SVG ---
        const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();

        img.onload = () => {
            const canvas = document.createElement('canvas');
            const bbox = svgEl.getBBox();

            // –º–∞—Å—à—Ç–∞–± (–º–æ–∂–µ—à –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ 2 –∞–±–æ 3 –¥–ª—è –∫—Ä–∞—â–æ—ó —è–∫–æ—Å—Ç—ñ)
            const scale = 3;

            canvas.width = bbox.width * scale;
            canvas.height = bbox.height * scale;

            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            ctx.drawImage(img, -bbox.x, -bbox.y);

            // PNG
            const pngUrl = canvas.toDataURL('image/png');

            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = 'ukraine-map.png';
            document.body.appendChild(a);
            a.click();
            a.remove();

            URL.revokeObjectURL(url);
        };

        img.src = url;
        });

    // --- helpers ---
    function rgbToHex(color) {
      // –ø—Ä–∏–π–º–∞—î rgb(...) –∞–±–æ #rrggbb
      if (!color) return null;
      const c = color.trim().toLowerCase();
      if (c.startsWith('#') && (c.length === 7 || c.length === 4)) return normalizeHex(c);

      const m = c.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/);
      if (!m) return null;
      const r = (+m[1]).toString(16).padStart(2,'0');
      const g = (+m[2]).toString(16).padStart(2,'0');
      const b = (+m[3]).toString(16).padStart(2,'0');
      return `#${r}${g}${b}`;
    }

    function normalizeHex(hex) {
      // #abc -> #aabbcc
      if (hex.length === 4) {
        return '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
      }
      return hex;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (ch) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[ch]));
    }
  </script>
</body>
</html>

